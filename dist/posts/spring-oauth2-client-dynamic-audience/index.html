<!DOCTYPE html><html lang="en" class="scroll-smooth"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="canonical" href="https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/"><meta name="generator" content="Astro v4.15.6"><!-- General Meta Tags --><title>Dynamically setting audience for using Spring OAuth2 Client | Coding Steve</title><meta name="title" content="Dynamically setting audience for using Spring OAuth2 Client | Coding Steve"><meta name="description" content="An article walking through a demo of dynamically setting a query parameter using spring-oauth2-client."><meta name="author" content="StevenPG"><link rel="sitemap" href="/sitemap-index.xml"><!-- Open Graph / Facebook --><meta property="og:title" content="Dynamically setting audience for using Spring OAuth2 Client | Coding Steve"><meta property="og:description" content="An article walking through a demo of dynamically setting a query parameter using spring-oauth2-client."><meta property="og:url" content="https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/"><meta property="og:image" content="https://i.imgur.com/4ICZldG.jpeg"><!-- Google --><script type="text/partytown" src="https://www.googletagmanager.com/gtag/js?id=G-2ZPXM6LPR3"></script> <script type="text/partytown" data-ga-measurement-id="G-2ZPXM6LPR3" id="ga-init">
  const measurementId = document
    .getElementById('ga-init')
    .getAttribute('data-ga-measurement-id')
  window.dataLayer = window.dataLayer || []
  function gtag() {
    dataLayer.push(arguments) // eslint-disable-line
  }
  gtag('js', new Date())
  gtag('config', measurementId)
</script><!-- Article Published/Modified time --><meta property="article:published_time" content="2025-06-02T12:00:00.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/"><meta property="twitter:title" content="Dynamically setting audience for using Spring OAuth2 Client | Coding Steve"><meta property="twitter:description" content="An article walking through a demo of dynamically setting a query parameter using spring-oauth2-client."><meta property="twitter:image" content="https://i.imgur.com/4ICZldG.jpeg"><!-- Google JSON-LD Structured data --><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dynamically setting audience for using Spring OAuth2 Client | Coding Steve","image":"https://i.imgur.com/4ICZldG.jpeg","datePublished":"2025-06-02T12:00:00.000Z","author":[{"@type":"Person","name":"StevenPG","url":"https://stevenpg.com/"}]}</script><!-- Google Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="preload" as="style" onload="this.onload=null; this.rel='stylesheet';" crossorigin><meta name="theme-color" content=""><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script src="/toggle-theme.js" async></script><link rel="stylesheet" href="/_astro/about.DJYXtY5I.css">
<style>a:where(.astro-blwjyjpt){position:relative;text-decoration-line:underline;text-decoration-style:dashed}a:where(.astro-blwjyjpt):hover{top:-.125rem;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}a:where(.astro-blwjyjpt):focus-visible{padding:.25rem}a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){margin-right:-1.25rem;height:1.5rem;width:1.5rem;--tw-scale-x: .95;--tw-scale-y: .95;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));--tw-text-opacity: 1;color:rgba(var(--color-text-base),var(--tw-text-opacity));opacity:.8}.group:where(.astro-blwjyjpt):hover a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){fill:rgb(var(--color-accent))}
@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*),::view-transition-old(*),::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}
.social-icons:where(.astro-wkojbtzc){display:flex;flex-direction:column;flex-wrap:wrap;align-items:center;justify-content:center;gap:.25rem}@media (min-width: 640px){.social-icons:where(.astro-wkojbtzc){align-items:flex-start}}.link-button:where(.astro-wkojbtzc){--tw-scale-x: .9;--tw-scale-y: .9;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));padding:.5rem}.link-button:where(.astro-wkojbtzc):hover{--tw-rotate: 6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@media (min-width: 640px){.link-button:where(.astro-wkojbtzc){padding:.25rem}}main:where(.astro-vj4tpspi){margin-left:auto;margin-right:auto;width:100%;max-width:48rem;padding-left:1rem;padding-right:1rem;padding-bottom:3rem}.post-title:where(.astro-vj4tpspi){font-size:1.5rem;line-height:2rem;font-weight:600;--tw-text-opacity: 1;color:rgba(var(--color-accent),var(--tw-text-opacity))}
</style><script type="module" src="/_astro/hoisted.BvA1nkMO.js"></script>
<script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.10.2 - MIT builder.io */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(v,1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script><style>[data-astro-transition-scope="astro-plk3gbjq-1"] { view-transition-name: dynamically-setting-audience-for-using-spring-o-auth-2-client; }@layer astro { ::view-transition-old(dynamically-setting-audience-for-using-spring-o-auth-2-client) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(dynamically-setting-audience-for-using-spring-o-auth-2-client) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(dynamically-setting-audience-for-using-spring-o-auth-2-client) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(dynamically-setting-audience-for-using-spring-o-auth-2-client) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-plk3gbjq-1"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-plk3gbjq-1"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-2"] { view-transition-name: software; }@layer astro { ::view-transition-old(software) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(software) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(software) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(software) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-2"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-2"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-3"] { view-transition-name: spring-boot; }@layer astro { ::view-transition-old(spring-boot) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(spring-boot) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(spring-boot) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(spring-boot) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-3"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-3"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-3"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-3"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-3"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-4"] { view-transition-name: java; }@layer astro { ::view-transition-old(java) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(java) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(java) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(java) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-4"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-4"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-4"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-4"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-4"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style><style>[data-astro-transition-scope="astro-36ssibgs-5"] { view-transition-name: oauth; }@layer astro { ::view-transition-old(oauth) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }::view-transition-new(oauth) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back]::view-transition-old(oauth) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back]::view-transition-new(oauth) { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; } }[data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-5"],
			[data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-5"],
			[data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }[data-astro-transition=back][data-astro-transition-fallback="old"] [data-astro-transition-scope="astro-36ssibgs-5"],
			[data-astro-transition=back][data-astro-transition-fallback="old"][data-astro-transition-scope="astro-36ssibgs-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeOut; }[data-astro-transition=back][data-astro-transition-fallback="new"] [data-astro-transition-scope="astro-36ssibgs-5"],
			[data-astro-transition=back][data-astro-transition-fallback="new"][data-astro-transition-scope="astro-36ssibgs-5"] { 
	animation-duration: 180ms;
	animation-timing-function: cubic-bezier(0.76, 0, 0.24, 1);
	animation-fill-mode: both;
	animation-name: astroFadeIn; }</style></head> <body>  <header class="astro-3ef6ksr2"> <a id="skip-to-content" href="#main-content" class="astro-3ef6ksr2">Skip to content</a> <div class="nav-container astro-3ef6ksr2"> <div class="top-nav-wrap astro-3ef6ksr2"> <a href="/" class="logo whitespace-nowrap astro-3ef6ksr2"> Coding Steve </a> <nav id="nav-menu" class="astro-3ef6ksr2"> <button class="hamburger-menu focus-outline astro-3ef6ksr2" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="menu-icon astro-3ef6ksr2"> <line x1="7" y1="12" x2="21" y2="12" class="line astro-3ef6ksr2"></line> <line x1="3" y1="6" x2="21" y2="6" class="line astro-3ef6ksr2"></line> <line x1="12" y1="18" x2="21" y2="18" class="line astro-3ef6ksr2"></line> <line x1="18" y1="6" x2="6" y2="18" class="close astro-3ef6ksr2"></line> <line x1="6" y1="6" x2="18" y2="18" class="close astro-3ef6ksr2"></line> </svg> </button> <ul id="menu-items" class="display-none sm:flex astro-3ef6ksr2"> <li class="astro-3ef6ksr2"> <a href="/posts/" class=" astro-3ef6ksr2">
Posts
</a> </li> <li class="astro-3ef6ksr2"> <a href="/tags/" class=" astro-3ef6ksr2">
Tags
</a> </li> <li class="astro-3ef6ksr2"> <a href="/oss/" class=" astro-3ef6ksr2">
OSS
</a> </li> <li class="astro-3ef6ksr2"> <a href="/about/" class=" astro-3ef6ksr2">
About
</a> </li> <li class="astro-3ef6ksr2"> <a href="/search/" class="group inline-block hover:text-skin-accent focus-outline p-3 sm:p-1  flex astro-3ef6ksr2" aria-label="search" title="Search"> <svg xmlns="http://www.w3.org/2000/svg" class="scale-125 sm:scale-100 astro-3ef6ksr2"><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class="astro-3ef6ksr2"></path> </svg> <span class="sr-only astro-3ef6ksr2">Search</span> </a> </li> <li class="astro-3ef6ksr2"> <button id="theme-btn" class="focus-outline astro-3ef6ksr2" title="Toggles light & dark" aria-label="auto" aria-live="polite"> <svg xmlns="http://www.w3.org/2000/svg" id="moon-svg" class="astro-3ef6ksr2"> <path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z" class="astro-3ef6ksr2"></path> </svg> <svg xmlns="http://www.w3.org/2000/svg" id="sun-svg" class="astro-3ef6ksr2"> <path d="M6.993 12c0 2.761 2.246 5.007 5.007 5.007s5.007-2.246 5.007-5.007S14.761 6.993 12 6.993 6.993 9.239 6.993 12zM12 8.993c1.658 0 3.007 1.349 3.007 3.007S13.658 15.007 12 15.007 8.993 13.658 8.993 12 10.342 8.993 12 8.993zM10.998 19h2v3h-2zm0-17h2v3h-2zm-9 9h3v2h-3zm17 0h3v2h-3zM4.219 18.363l2.12-2.122 1.415 1.414-2.12 2.122zM16.24 6.344l2.122-2.122 1.414 1.414-2.122 2.122zM6.342 7.759 4.22 5.637l1.415-1.414 2.12 2.122zm13.434 10.605-1.414 1.414-2.122-2.122 1.414-1.414z" class="astro-3ef6ksr2"></path> </svg> </button> </li> </ul> </nav> </div> </div> <div class="max-w-3xl mx-auto px-4"> <hr class="border-skin-line" aria-hidden="true"> </div> </header>   <div class="mx-auto flex w-full max-w-3xl justify-start px-2 astro-vj4tpspi"> <button class="focus-outline mb-2 mt-8 flex hover:opacity-75 astro-vj4tpspi" onclick="(() => (history.length === 1) ? window.location = '/' : history.back())()"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-vj4tpspi"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg><span class="astro-vj4tpspi">Go back</span> </button> </div> <main id="main-content" class="astro-vj4tpspi"> <h1 class="post-title astro-vj4tpspi" data-astro-transition-scope="astro-plk3gbjq-1">Dynamically setting audience for using Spring OAuth2 Client</h1> <div class="flex items-center space-x-2 opacity-80 my-2 astro-vj4tpspi"><svg xmlns="http://www.w3.org/2000/svg" class="scale-100 inline-block h-6 w-6 min-w-[1.375rem] fill-skin-base" aria-hidden="true"><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class="sr-only">Published:</span><span class="italic text-base"><time dateTime="2025-06-02T12:00:00.000Z">Jun 2, 2025</time><span aria-hidden="true"> | </span><span class="sr-only"> at </span><span class="text-nowrap">08:00 AM</span></span></div> <article id="article" class="prose mx-auto mt-8 max-w-3xl astro-vj4tpspi"> <h2 id="table-of-contents">Table of Contents</h2>
<p></p><details><summary>Open Table of Contents</summary><p></p>
<ul>
<li><a href="#brief">Brief</a></li>
<li><a href="#what-is-oauth2">What is OAuth2?</a>
<ul>
<li><a href="#why-do-i-care">Why do I care?</a></li>
<li><a href="#spring-security---component-model">Spring Security - Component Model</a>
<ul>
<li><a href="#setting-up-our-overrides">Setting up our Overrides</a></li>
<li><a href="#the-classes-at-play">The Classes at Play</a>
<ul>
<li><a href="#authorizedclientserviceoauth2authorizedclientmanager">AuthorizedClientServiceOAuth2AuthorizedClientManager</a></li>
<li><a href="#clientcredentialsoauth2authorizedclientprovider">ClientCredentialsOAuth2AuthorizedClientProvider</a></li>
<li><a href="#oauth2clienthttprequestinterceptor">OAuth2ClientHttpRequestInterceptor</a></li>
<li><a href="#oauth2clientcredentialsgrantrequest">OAuth2ClientCredentialsGrantRequest</a></li>
<li><a href="#oauth2accesstokenresponseclient">OAuth2AccessTokenResponseClient</a></li>
</ul>
</li>
<li><a href="#overriding-and-injecting">Overriding and Injecting</a>
<ul>
<li><a href="#audiencewritingauthorizedclientserviceoauth2authorizedclientmanager">AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</a></li>
<li><a href="#audiencewritingclientcredentialsoauth2authorizedclientprovider">AudienceWritingClientCredentialsOAuth2AuthorizedClientProvider</a></li>
<li><a href="#audiencewritingoauth2clienthttprequestinterceptor">AudienceWritingOAuth2ClientHttpRequestInterceptor</a></li>
<li><a href="#oauth2clientcredentialsaudiencedgrantrequest">OAuth2ClientCredentialsAudiencedGrantRequest</a></li>
<li><a href="#audiencewritingoauth2accesstokenresponseclient">AudienceWritingOAuth2AccessTokenResponseClient</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p></p></details><p></p>
<h1 id="brief">Brief</h1>
<p>My goal is to make posts like this the SIMPLEST place on the internet to learn how to do things
that caused me trouble. That way, if this is found, someone doesn’t have to do the same digging I had to do.</p>
<p>This post DOES assume you have a basic understanding of OAuth2 and Spring Security around classes and concepts like ClientRegistrations and AuthorizationGrantType.</p>
<p>If you’re missing that, go do a sample project of basic OAuth2 and come back later!</p>
<h1 id="what-is-oauth2">What is OAuth2?</h1>
<p>OAuth2 is a popular authorization framework that allows users to grant
third-party applications access to their data without revealing their
credentials. It’s often used for services like social media logins, API integrations, and more.</p>
<p>Tokens used in the OAuth2 process have required and optional claims. These claims are simple fields that are validated by the receiver of the token as defined in
<a href="https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.3">https://datatracker.ietf.org/doc/html/rfc7519#section-4.1.3</a>.</p>
<p>One of these claims is the “aud” claim, or the audience claim.</p>
<p>The “aud” (audience) claim identifies the recipients that the JWT is intended for and principal that intends to process the JWT must identify itself with a value in the audience claim; otherwise, the JWT must be rejected. The “aud” value is typically an array of case-sensitive strings, each containing a StringOrURI value, though it can also be a single case-sensitive string when there is only one audience. The interpretation of audience values is generally application-specific, and the use of this claim is optional. This is all for defense against “replay attacks”, where a token is re-used to call a different target once it’s stolen from the initial request.</p>
<h2 id="why-do-i-care">Why do I care?</h2>
<p>In most systems, these audience claims are set by the OAuth2 provider. For example, if you have a client configured for your application that calls server-a,
the oauth2 server might set every user of that client to automatically set the audience to `“aud”: “server-a”. This means a client like Spring’s oauth2-client
has no reason to care about the audience on the token.</p>
<p>However, there is an uncommon scenario where a federated set of systems may need to dynamically set the audience claim. This is usually done by allowing some
sort of query_parameter on the token request. For example; providing an <code>intended_audience=my-target-server</code> query parameter. This would inform the oauth server
to set the audience claim to <code>"aud": "my-target-server"</code>.</p>
<h2 id="spring-security---component-model">Spring Security - Component Model</h2>
<p>The main goal of this article is to have a single source of information for setting up custom Client Credentials Provider in Spring Security. The example in this post will be dynamically setting the “aud” claim based on the target host.</p>
<p><img src="/assets/spring-security-oauth2-a30814fe.png" alt="Class Diagram"></p>
<h3 id="setting-up-our-overrides">Setting up our Overrides</h3>
<p>Many of these classes are final, so to implement our functionality, we’re going to create sibling classes and inject them into the Spring Security management layer so that we can control our token requests!</p>
<p>We set up the initial configuration in a <code>RestClientConfiguration</code> class</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">@</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Configuration</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> RestClientConfiguration</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Bean</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientManager</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> authorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            ClientRegistrationRepository</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> clientRegistrationRepository</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            OAuth2AuthorizedClientService</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizedClientService</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">    )</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">{</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> We create a manager using the autowired clientRegistrations from YAML and connect it to the service</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClientManager</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">clientRegistrationRepository</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> authorizedClientService</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> Setting the clientManager to look for a clientCredentials configuration</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        authorizedClientManager</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">setAuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingClientCredentialsOAuth2AuthorizedClientProvider</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> This customizer is crucial for passing RestClient attributes to the OAuth2AuthorizeRequest</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        authorizedClientManager</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">setContextAttributesMapper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizeRequest </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> The OAuth2AuthorizedClientInterceptor automatically copies RestClient's</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> attributes into the OAuth2AuthorizeRequest's attributes.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> So, we just return the existing attributes.</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HashMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>(</span><span style="color:#1976D2;--shiki-dark:#C5E478">authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAttributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">);</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClientManager;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Bean</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> RestClient</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> oauth2RestClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            OAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> We instantiate a new interceptor to load into RestClient</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        AudienceWritingOAuth2ClientHttpRequestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> oAuth2ClientHttpRequestInterceptor</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingOAuth2ClientHttpRequestInterceptor</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">authorizedClientManager</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> Then provide it the client registration to resolve the id from</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> From here we simply return the client with any custom configuration, and we're good to go!</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#1976D2;--shiki-dark:#C5E478"> RestClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">builder</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">baseUrl</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">https://httpbin.org/headers</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">requestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">oAuth2ClientHttpRequestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">build</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<h3 id="the-classes-at-play">The Classes at Play</h3>
<p>With our initial configuration, the following classes are what we’re going to be either extending or overwriting. Our overridden versions will be included below this section:</p>
<p>Please note: This is focusing on the ClientCredentials grant type for OAuth2. The other types are
similar but may have different classes or class hierarchy.</p>
<h4 id="authorizedclientserviceoauth2authorizedclientmanager">AuthorizedClientServiceOAuth2AuthorizedClientManager</h4>
<p>This manager contains the overall configuration and bootstrapping of the token retrieving operation
that executes automagically before RestClient requests that are configured to utilize it.</p>
<p>The bean we define in the <code>RestClientConfiguration</code> returns an OAuth2AuthorizedClientManager, with the
referenced class here being just one example. This bean is then used to instantiate the RestClient’s
ClientHttpRequestInterceptor.</p>
<p><a href="https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/AuthorizedClientServiceOAuth2AuthorizedClientManager.java">https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/AuthorizedClientServiceOAuth2AuthorizedClientManager.java</a></p>
<h4 id="clientcredentialsoauth2authorizedclientprovider">ClientCredentialsOAuth2AuthorizedClientProvider</h4>
<p>OAuth2AuthorizedClientProvider implementations attempt to authorize or re-authorize the configured ClientRegistration. It contains a context object that maintains the relevant information for performing
the aforementioned authorizaton or re-authorizations.</p>
<p><a href="https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/ClientCredentialsOAuth2AuthorizedClientProvider.java">https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/ClientCredentialsOAuth2AuthorizedClientProvider.java</a></p>
<h4 id="oauth2clienthttprequestinterceptor">OAuth2ClientHttpRequestInterceptor</h4>
<p>This is a new class that provides an easy mechanism for using an OAuth2AuthorizedClient to make requests
by automatically injecting a bearer token for OAuth2 requests. It is defined in our <code>RestClientConfiguration</code> above.</p>
<p><a href="https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/web/client/OAuth2ClientHttpRequestInterceptor.java">https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/web/client/OAuth2ClientHttpRequestInterceptor.java</a></p>
<h4 id="oauth2clientcredentialsgrantrequest">OAuth2ClientCredentialsGrantRequest</h4>
<p>This object contains the client credentials and other client registration details relevant for querying
for a new token.</p>
<p><a href="https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/endpoint/OAuth2ClientCredentialsGrantRequest.java">https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/endpoint/OAuth2ClientCredentialsGrantRequest.java</a></p>
<h4 id="oauth2accesstokenresponseclient">OAuth2AccessTokenResponseClient</h4>
<p>This class performs the actual exchange for an access token at the authorization server’s token endpoint. This parent class is implemented based on the underlying oauth2 type. In this post, we’ll
be overriding the ClientCredentials implementation of a TokenResponseClient.</p>
<p><a href="https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/endpoint/OAuth2AccessTokenResponseClient.java">https://github.com/spring-projects/spring-security/blob/6.5.0/oauth2/oauth2-client/src/main/java/org/springframework/security/oauth2/client/endpoint/OAuth2AccessTokenResponseClient.java</a></p>
<h3 id="overriding-and-injecting">Overriding and Injecting</h3>
<h4 id="audiencewritingauthorizedclientserviceoauth2authorizedclientmanager">AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</h4>
<p>In our version of this class, we’re going to implement the base OAuth2AuthorizedClientManager class.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> implements</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> OAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> DEFAULT_AUTHORIZED_CLIENT_PROVIDER</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientProviderBuilder</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">builder</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">clientCredentials</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">build</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> ClientRegistrationRepository</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistrationRepository</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientService</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClientService</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Function</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Object</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">>> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">contextAttributesMapper</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizationSuccessHandler</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizationSuccessHandler</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizationFailureHandler</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizationFailureHandler</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    /**</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * Constructs an {@code AuthorizedClientServiceOAuth2AuthorizedClientManager} using</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * the provided parameters.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> clientRegistrationRepository</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the repository of client registrations</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> authorizedClientService</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the authorized client service</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">     */</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingAuthorizedClientServiceOAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            ClientRegistrationRepository</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> clientRegistrationRepository</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            OAuth2AuthorizedClientService</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizedClientService</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistrationRepository</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">clientRegistrationRepository cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClientService</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">authorizedClientService cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clientRegistrationRepository</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> clientRegistrationRepository;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientService</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClientService;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientProvider</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> DEFAULT_AUTHORIZED_CLIENT_PROVIDER;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">contextAttributesMapper</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> AuthorizedClientServiceOAuth2AuthorizedClientManager</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">DefaultContextAttributesMapper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizationSuccessHandler</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> attributes) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClientService</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">saveAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizationFailureHandler</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> RemoveAuthorizedClientOAuth2AuthorizationFailureHandler</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">                (clientRegistrationId</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> attributes) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> authorizedClientService</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#82AAFF">                        .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">removeAuthorizedClient</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">clientRegistrationId</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> principal</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getName</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Nullable</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Override</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClient</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> authorize</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">authorizeRequest cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistrationId</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getClientRegistrationId</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        Authentication</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> principal</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getPrincipal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Builder</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> contextBuilder</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            contextBuilder </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2AuthorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">withAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        else</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            ClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistration</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clientRegistrationRepository</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">findByRegistrationId</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistrationId</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistration</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">                    "</span><span style="color:#22863A;--shiki-dark:#ECC48D">Could not find ClientRegistration with id '</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> +</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> clientRegistrationId </span><span style="color:#D32F2F;--shiki-dark:#C792EA">+</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">'</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientService</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">loadAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistrationId</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                    principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getName</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                contextBuilder </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2AuthorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">withAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            else</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                contextBuilder </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2AuthorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">withClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizationContext</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizationContext</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> buildAuthorizationContext</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">authorizeRequest</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">                contextBuilder</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        try</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientProvider</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">authorize</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizationContext</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        catch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizationException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> ex</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">            this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizationFailureHandler</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">onAuthorizationFailure</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">ex</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> Collections</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">emptyMap</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ex;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">            this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizationSuccessHandler</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">onAuthorizationSuccess</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                    Collections</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">emptyMap</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        else</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> In the case of re-authorization, the returned `authorizedClient` may be</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> null if re-authorization is not supported.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> For these cases, return the provided</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> `authorizationContext.authorizedClient`.</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#1976D2;--shiki-dark:#C5E478">authorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> !=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                return</span><span style="color:#1976D2;--shiki-dark:#C5E478"> authorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClient;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizationContext</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> buildAuthorizationContext</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                                                 Authentication</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizationContext</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Builder</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> contextBuilder</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:off</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#1976D2;--shiki-dark:#C5E478"> contextBuilder</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">attributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(attributes) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                    Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Object</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">contextAttributes</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">contextAttributesMapper</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">apply</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                    if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">!</span><span style="color:#1976D2;--shiki-dark:#C5E478">CollectionUtils</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">isEmpty</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">contextAttributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                        attributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">putAll</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">contextAttributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                    }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                }</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">build</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:on</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    /**</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * Sets the {@link OAuth2AuthorizedClientProvider} used for authorizing (or</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * re-authorizing) an OAuth 2.0 Client.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> authorizedClientProvider</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the {@link OAuth2AuthorizedClientProvider} used for</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * authorizing (or re-authorizing) an OAuth 2.0 Client</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">     */</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> setAuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClientProvider</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">authorizedClientProvider cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientProvider</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClientProvider;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    /**</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * Sets the {@code Function} used for mapping attribute(s) from the</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * {@link OAuth2AuthorizeRequest} to a {@code Map} of attributes to be associated to</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * the {</span><span style="color:#D32F2F;--shiki-dark:#C792EA">@link</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AuthorizationContext</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">#</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic">getAttributes()</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> authorization context}.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> contextAttributesMapper</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the {@code Function} used for supplying the</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * {@code Map} of attributes to the {@link OAuth2AuthorizationContext#getAttributes()</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * authorization context}</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">     */</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> setContextAttributesMapper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            Function</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Object</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">>> </span><span style="color:#24292EFF;--shiki-dark:#D7DBE0">contextAttributesMapper</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">contextAttributesMapper</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">contextAttributesMapper cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">contextAttributesMapper</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> contextAttributesMapper;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<h4 id="audiencewritingclientcredentialsoauth2authorizedclientprovider">AudienceWritingClientCredentialsOAuth2AuthorizedClientProvider</h4>
<p>OAuth2AuthorizedClientProvider implementations attempt to authorize or re-authorize the configured ClientRegistration. It contains a context object that maintains the relevant information for performing
the aforementioned authorizaton or re-authorizations.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> AudienceWritingClientCredentialsOAuth2AuthorizedClientProvider</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> implements</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> OAuth2AuthorizedClientProvider</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> AudienceWritingOAuth2AccessTokenResponseClient</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> accessTokenResponseClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingOAuth2AccessTokenResponseClient</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Duration</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clockSkew</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> Duration</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">ofSeconds</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#F78C6C">60</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Clock</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clock</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> Clock</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">systemUTC</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    /**</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * Attempt to authorize (or re-authorize) the</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * {</span><span style="color:#D32F2F;--shiki-dark:#C792EA">@link</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AuthorizationContext</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">#</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic">getClientRegistration()</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> client} in the provided</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * {@code context}. Returns {@code null} if authorization (or re-authorization) is not</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * supported, e.g. the client's {@link ClientRegistration#getAuthorizationGrantType()</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * authorization grant type} is not {@link AuthorizationGrantType#CLIENT_CREDENTIALS</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * client_credentials} OR the {@link OAuth2AuthorizedClient#getAccessToken() access</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * token} is not expired.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> context</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the context that holds authorization-specific state for the client</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@return</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the {@link OAuth2AuthorizedClient} or {@code null} if authorization (or</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * re-authorization) is not supported</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">     */</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Override</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Nullable</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClient</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> authorize</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizationContext</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> context</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">context</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">context cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        ClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistration</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> context</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">!</span><span style="color:#1976D2;--shiki-dark:#C5E478">AuthorizationGrantType</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">CLIENT_CREDENTIALS</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">equals</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">clientRegistration</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAuthorizationGrantType</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> context</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x26;&#x26;</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> !</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">hasTokenExpired</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">authorizedClient</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAccessToken</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> If client is already authorized but access token is NOT expired than no</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> need for re-authorization</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> As per spec, in section 4.4.3 Access Token Response</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> https://tools.ietf.org/html/rfc6749#section-4.4.3</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> A refresh token SHOULD NOT be included.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> Therefore, renewing an expired access token (re-authorization)</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">        //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> is the same as acquiring a new access token (authorization).</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientCredentialsGrantRequest</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">                clientRegistration</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> context</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAttribute</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">audience</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AccessTokenResponse</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> tokenResponse</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> getTokenResponse</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">clientRegistration</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> clientCredentialsGrantRequest</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AuthorizedClient</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">clientRegistration</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> context</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getPrincipal</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getName</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                tokenResponse</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAccessToken</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AccessTokenResponse</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> getTokenResponse</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">ClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> clientRegistration</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                                       OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> clientCredentialsGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        try</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">accessTokenResponseClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getTokenResponse</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientCredentialsGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        catch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizationException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> ex</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> ClientAuthorizationException</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">ex</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getError</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> clientRegistration</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getRegistrationId</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> ex</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> boolean</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> hasTokenExpired</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2Token</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> token</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clock</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">instant</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">isAfter</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">token</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getExpiresAt</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">minus</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#7FDBCA">this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clockSkew</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<h4 id="audiencewritingoauth2clienthttprequestinterceptor">AudienceWritingOAuth2ClientHttpRequestInterceptor</h4>
<p>This is a new class that provides an easy mechanism for using an OAuth2AuthorizedClient to make requests
by automatically injecting a bearer token for OAuth2 requests. It is defined in our <code>RestClientConfiguration</code> above.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> AudienceWritingOAuth2ClientHttpRequestInterceptor</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> implements</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> ClientHttpRequestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:off</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">HttpStatusCode</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">OAUTH2_ERROR_CODES</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> Map</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">of</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            HttpStatus</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">UNAUTHORIZED</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2ErrorCodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">INVALID_TOKEN</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            HttpStatus</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">FORBIDDEN</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2ErrorCodes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">INSUFFICIENT_SCOPE</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D9F5DD">    )</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Authentication</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> ANONYMOUS_AUTHENTICATION</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AnonymousAuthenticationToken</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">anonymous</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">            "</span><span style="color:#22863A;--shiki-dark:#ECC48D">anonymousUser</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> AuthorityUtils</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">createAuthorityList</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">ROLE_ANONYMOUS</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2ClientHttpRequestInterceptor</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">ClientRegistrationIdResolver</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistrationIdResolver</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> RequestAttributeClientRegistrationIdResolver</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2ClientHttpRequestInterceptor</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">PrincipalResolver</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> principalResolver</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> SecurityContextHolderPrincipalResolver</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:off</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AuthorizationFailureHandler</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizationFailureHandler</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            (clientRegistrationId</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> attributes) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> { };</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    /**</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * Constructs a {@code OAuth2ClientHttpRequestInterceptor} using the provided</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * parameters.</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * </span><span style="color:#D32F2F;--shiki-dark:#C792EA">@param</span><span style="color:#C2C3C5;--shiki-dark:#D7DBE0;font-style:inherit;--shiki-dark-font-style:italic"> authorizedClientManager</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> the {@link OAuth2AuthorizedClientManager} which</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic">     * manages the authorized client(s)</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">     */</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> AudienceWritingOAuth2ClientHttpRequestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizedClientManager</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizedClientManager</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">authorizedClientManager cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientManager</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> authorizedClientManager;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Override</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> ClientHttpResponse</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> intercept</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">HttpRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> byte</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[] </span><span style="color:#24292EFF;--shiki-dark:#D7DBE0">body</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> ClientHttpRequestExecution</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> execution</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throws</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> IOException</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        Authentication</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> principal</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">principalResolver</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">resolve</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">request</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (principal </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            principal </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ANONYMOUS_AUTHENTICATION;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        authorizeClient</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">request</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        try</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            ClientHttpResponse</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> response</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> execution</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">execute</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> body</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">            handleAuthorizationFailure</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">request</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> response</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getHeaders</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> response</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getStatusCode</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> response;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        catch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">RestClientResponseException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> ex</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">            handleAuthorizationFailure</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">request</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> ex</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getResponseHeaders</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> ex</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getStatusCode</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ex;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        catch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizationException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> ex</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">            handleAuthorizationFailure</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">ex</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> ex;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> authorizeClient</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">HttpRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Authentication</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistrationId</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clientRegistrationIdResolver</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">resolve</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">request</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (clientRegistrationId </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizeRequest</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAuth2AuthorizeRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">withClientRegistrationId</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">clientRegistrationId</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">attribute</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">audience</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAttributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">get</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">audience</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">))</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">build</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2AuthorizedClient</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizedClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizedClientManager</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">authorize</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizeRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (authorizedClient </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            request</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getHeaders</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">setBearerAuth</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">authorizedClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAccessToken</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getTokenValue</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> handleAuthorizationFailure</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">HttpRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Authentication</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HttpHeaders</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> headers</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                            HttpStatusCode</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> httpStatus</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        OAuth2Error</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> error</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> resolveOAuth2ErrorIfPossible</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">headers</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> httpStatus</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (error </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistrationId</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">clientRegistrationIdResolver</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">resolve</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">request</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (clientRegistrationId </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        ClientAuthorizationException</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> authorizationException</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> ClientAuthorizationException</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">error</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF">                clientRegistrationId</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        handleAuthorizationFailure</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">authorizationException</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> principal</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2Error</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> resolveOAuth2ErrorIfPossible</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">HttpHeaders</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> headers</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HttpStatusCode</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> httpStatus</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> wwwAuthenticateHeader</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> headers</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getFirst</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">HttpHeaders</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">WWW_AUTHENTICATE</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (wwwAuthenticateHeader </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">parameters</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> parseWwwAuthenticateHeader</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">wwwAuthenticateHeader</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#1976D2;--shiki-dark:#C5E478">parameters</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">containsKey</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">OAuth2ParameterNames</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">ERROR</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                return</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2Error</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">parameters</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">get</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">OAuth2ParameterNames</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">ERROR</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                        parameters</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">get</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">OAuth2ParameterNames</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">ERROR_DESCRIPTION</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                        parameters</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">get</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">OAuth2ParameterNames</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">ERROR_URI</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> errorCode</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> OAUTH2_ERROR_CODES</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">get</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">httpStatus</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (errorCode </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2Error</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">errorCode</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">https://tools.ietf.org/html/rfc6750#section-3.1</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">parseWwwAuthenticateHeader</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> wwwAuthenticateHeader</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">!</span><span style="color:#1976D2;--shiki-dark:#C5E478">StringUtils</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">hasLength</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">wwwAuthenticateHeader</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                ||</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> !</span><span style="color:#1976D2;--shiki-dark:#C5E478">StringUtils</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">startsWithIgnoreCase</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">wwwAuthenticateHeader</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">bearer</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#1976D2;--shiki-dark:#C5E478"> Map</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">of</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> headerValue</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> wwwAuthenticateHeader</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">substring</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">bearer</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">length</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">stripLeading</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">parameters</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HashMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>();</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        for</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> kvPair</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> :</span><span style="color:#1976D2;--shiki-dark:#C5E478"> StringUtils</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">delimitedListToStringArray</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">headerValue</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">[] </span><span style="color:#24292EFF;--shiki-dark:#C5E478">kv</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> StringUtils</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">split</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">kvPair</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">=</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (kv </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> ||</span><span style="color:#1976D2;--shiki-dark:#C5E478"> kv</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">length</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> &#x3C;=</span><span style="color:#1976D2;--shiki-dark:#F78C6C"> 1</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                continue</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            parameters</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">put</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">kv[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">0</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">trim</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> kv[</span><span style="color:#1976D2;--shiki-dark:#F78C6C">1</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">]</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">trim</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">replace</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#F78C6C">\"</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> ""</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> parameters;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> handleAuthorizationFailure</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2AuthorizationException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> authorizationException</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                            Authentication</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> principal</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        ServletRequestAttributes</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> requestAttributes</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (ServletRequestAttributes) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">RequestContextHolder</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getRequestAttributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        Map</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Object</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">attributes</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HashMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>();</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (requestAttributes </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">            attributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">put</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">HttpServletRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">class</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getName</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> requestAttributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#1976D2;--shiki-dark:#C5E478">requestAttributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getResponse</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> !=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                attributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">put</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">HttpServletResponse</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">class</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getName</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> requestAttributes</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getResponse</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">authorizationFailureHandler</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">onAuthorizationFailure</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">authorizationException</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> principal</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> attributes</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<h4 id="oauth2clientcredentialsaudiencedgrantrequest">OAuth2ClientCredentialsAudiencedGrantRequest</h4>
<p>This object contains the client credentials and other client registration details relevant for querying
for a new token.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> extends</span><span style="color:#6F42C1;--shiki-dark:#C5E478"> OAuth2ClientCredentialsGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> audience</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">ClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> clientRegistration</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> audience</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#7FDBCA">        super</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(clientRegistration);</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">audience</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> audience;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> getAudience</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> audience;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<h4 id="audiencewritingoauth2accesstokenresponseclient">AudienceWritingOAuth2AccessTokenResponseClient</h4>
<p>This class performs the actual exchange for an access token at the authorization server’s token endpoint. This parent class is implemented based on the underlying oauth2 type. In this post, we’ll
be overriding the ClientCredentials implementation of a TokenResponseClient.</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">@</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Component</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">public</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> class</span><span style="color:#6F42C1;--shiki-dark:#FFCB8B"> AudienceWritingOAuth2AccessTokenResponseClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> implements</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#C5E478">        OAuth2AccessTokenResponseClient</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Logger</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> logger</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> LoggerFactory</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getLogger</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">AudienceWritingOAuth2AccessTokenResponseClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">class</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> static</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> INVALID_TOKEN_RESPONSE_ERROR_CODE</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">invalid_token_response</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:off</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> RestClient</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> restClient</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> RestClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">builder</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">messageConverters</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(messageConverters) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                messageConverters</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">clear</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                messageConverters</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">add</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> FormHttpMessageConverter</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                messageConverters</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">add</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AccessTokenResponseHttpMessageConverter</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">requestInterceptor</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">body</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">execution)</span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">                //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> This interceptor is not used in this implementation, but can be customized if needed</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                logger</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">info</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#22863A;--shiki-dark:#ECC48D">Request URI: {}</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> request</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getURI</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                return</span><span style="color:#1976D2;--shiki-dark:#C5E478"> execution</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">execute</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">request</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> body</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">defaultStatusHandler</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2ErrorResponseErrorHandler</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">            .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">build</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">    //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:on</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Converter</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> HttpHeaders</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">headersConverter</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> DefaultOAuth2TokenRequestHeadersConverter</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Converter</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> MultiValueMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">>> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">parametersConverter</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> DefaultOAuth2TokenRequestParametersConverter</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> final</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> Consumer</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">MultiValueMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">>> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">parametersCustomizer</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (parameters) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    @</span><span style="color:#D32F2F;--shiki-dark:#C792EA">Override</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    public</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> OAuth2AccessTokenResponse</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> getTokenResponse</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> grantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">        Assert</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">notNull</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">grantRequest cannot be null</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        try</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:off</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            OAuth2AccessTokenResponse</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> accessTokenResponse</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">validatingPopulateRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#1976D2;--shiki-dark:#C5E478"> grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getAudience</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">())</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">retrieve</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                    .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">body</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">OAuth2AccessTokenResponse</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">class</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#C2C3C5;--shiki-dark:#637777">            //</span><span style="color:#C2C3C5;--shiki-dark:#637777;font-style:inherit;--shiki-dark-font-style:italic"> @formatter:on</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (accessTokenResponse </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                OAuth2Error</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> error</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2Error</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">INVALID_TOKEN_RESPONSE_ERROR_CODE</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">                        "</span><span style="color:#22863A;--shiki-dark:#ECC48D">Empty OAuth 2.0 Access Token Response</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                throw</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AuthorizationException</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">error</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            }</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            return</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> accessTokenResponse;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        } </span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">catch</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">RestClientException</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> ex</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">            OAuth2Error</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> error</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2Error</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">INVALID_TOKEN_RESPONSE_ERROR_CODE</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">                    "</span><span style="color:#22863A;--shiki-dark:#ECC48D">An error occurred while attempting to retrieve the OAuth 2.0 Access Token Response: </span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                            +</span><span style="color:#1976D2;--shiki-dark:#C5E478"> ex</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getMessage</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#82AAFF">                    null</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> OAuth2AuthorizationException</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">error</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> ex</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> RestClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">RequestHeadersSpec</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">?</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">validatingPopulateRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                                                       String</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> audience</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">        validateClientAuthenticationMethod</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">grantRequest</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> populateRequest</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#6F42C1;--shiki-dark:#82AAFF">grantRequest</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> audience</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> void</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> validateClientAuthenticationMethod</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> grantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        ClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientRegistration</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        ClientAuthenticationMethod</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> clientAuthenticationMethod</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> clientRegistration</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getClientAuthenticationMethod</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        boolean</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> supportedClientAuthenticationMethod</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> clientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">equals</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">ClientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">NONE</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                ||</span><span style="color:#1976D2;--shiki-dark:#C5E478"> clientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">equals</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">ClientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">CLIENT_SECRET_BASIC</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                ||</span><span style="color:#1976D2;--shiki-dark:#C5E478"> clientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">equals</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">ClientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">CLIENT_SECRET_POST</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (</span><span style="color:#D32F2F;--shiki-dark:#C792EA">!</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">supportedClientAuthenticationMethod) {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">            throw</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic"> IllegalArgumentException</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span><span style="color:#1976D2;--shiki-dark:#C5E478">String</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">format</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">(</span></span>
<span class="line"><span style="color:#22863A;--shiki-dark:#D9F5DD">                    "</span><span style="color:#22863A;--shiki-dark:#ECC48D">This class supports `client_secret_basic`, `client_secret_post`, and `none` by default. Client [%s] is using [%s] instead. Please use a supported client authentication method, or use `set/addParametersConverter` or `set/addHeadersConverter` to supply an instance that supports [%s].</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                    clientRegistration</span><span style="color:#212121;--shiki-dark:#82AAFF">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getRegistrationId</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> clientAuthenticationMethod</span><span style="color:#212121;--shiki-dark:#82AAFF">,</span><span style="color:#6F42C1;--shiki-dark:#82AAFF"> clientAuthenticationMethod</span><span style="color:#6F42C1;--shiki-dark:#D9F5DD">))</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">    private</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> RestClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#D32F2F;--shiki-dark:#C792EA">RequestHeadersSpec</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">?</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">populateRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#D32F2F;--shiki-dark:#C792EA">OAuth2ClientCredentialsAudiencedGrantRequest</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                                                             String</span><span style="color:#24292EFF;--shiki-dark:#D7DBE0"> audience</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        MultiValueMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;</span><span style="color:#D32F2F;--shiki-dark:#C792EA">String</span><span style="color:#212121;--shiki-dark:#D6DEEB">,</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> String</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">> </span><span style="color:#24292EFF;--shiki-dark:#C5E478">parameters</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">parametersConverter</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">convert</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">grantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (parameters </span><span style="color:#D32F2F;--shiki-dark:#C792EA">==</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">            parameters </span><span style="color:#D32F2F;--shiki-dark:#C792EA">=</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> new</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> LinkedMultiValueMap</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">&#x3C;>();</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">        }</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#7FDBCA">        this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">parametersCustomizer</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">accept</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">parameters</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">        var</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> tokenRequestUri</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#C5E478"> grantRequest</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getClientRegistration</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getProviderDetails</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">getTokenUri</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                +</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (audience </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic"> ?</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> "</span><span style="color:#22863A;--shiki-dark:#ECC48D">?audience=</span><span style="color:#22863A;--shiki-dark:#D9F5DD">"</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> +</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> audience </span><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">:</span><span style="color:#22863A;--shiki-dark:#D9F5DD"> ""</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">);;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">        return</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">restClient</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">post</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">()</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">uri</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">tokenRequestUri</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">headers</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">(headers) </span><span style="color:#D32F2F;--shiki-dark:#C792EA">-></span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> {</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA">                    HttpHeaders</span><span style="color:#24292EFF;--shiki-dark:#C5E478"> headersToAdd</span><span style="color:#D32F2F;--shiki-dark:#C792EA"> =</span><span style="color:#1976D2;--shiki-dark:#7FDBCA"> this</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#1976D2;--shiki-dark:#FAF39F;font-style:inherit;--shiki-dark-font-style:italic">headersConverter</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">convert</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">grantRequest</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#D32F2F;--shiki-dark:#C792EA;font-style:inherit;--shiki-dark-font-style:italic">                    if</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB"> (headersToAdd </span><span style="color:#D32F2F;--shiki-dark:#C792EA">!=</span><span style="color:#1976D2;--shiki-dark:#82AAFF"> null</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">) {</span></span>
<span class="line"><span style="color:#1976D2;--shiki-dark:#C5E478">                        headers</span><span style="color:#212121;--shiki-dark:#D6DEEB">.</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">addAll</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">headersToAdd</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                    }</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">                }</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span></span>
<span class="line"><span style="color:#212121;--shiki-dark:#D6DEEB">                .</span><span style="color:#6F42C1;--shiki-dark:#82AAFF;font-style:inherit;--shiki-dark-font-style:italic">body</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">(</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">parameters</span><span style="color:#24292EFF;--shiki-dark:#D9F5DD">)</span><span style="color:#24292EFF;--shiki-dark:#D6DEEB">;</span></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292EFF;--shiki-dark:#D6DEEB">}</span></span>
<span class="line"></span></code></pre>
<p>The demo files are available here: <a href="https://github.com">https://github.com</a>](<a href="https://github.com/StevenPG/spring-security-oauth2-client-credentials-demo">https://github.com/StevenPG/spring-security-oauth2-client-credentials-demo</a></p>
<p>Sample Output from the test project!</p>
<pre class="astro-code astro-code-themes min-light night-owl" style="background-color:#ffffff;--shiki-dark-bg:#011627;color:#24292eff;--shiki-dark:#d6deeb; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="text"><code><span class="line"><span> :: Spring Boot ::                (v3.5.0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2025-06-04T01:56:49.335-04:00  INFO 16165 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication using Java 24.0.1 with PID 16165 (/spring-security-oauth2-client-credentials-demo/build/classes/java/main started by user in /spring-security-oauth2-client-credentials-demo)</span></span>
<span class="line"><span>2025-06-04T01:56:49.336-04:00  INFO 16165 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to 1 default profile: "default"</span></span>
<span class="line"><span>2025-06-04T01:56:49.597-04:00  INFO 16165 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 8081 (http)</span></span>
<span class="line"><span>2025-06-04T01:56:49.601-04:00  INFO 16165 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span></span>
<span class="line"><span>2025-06-04T01:56:49.601-04:00  INFO 16165 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.41]</span></span>
<span class="line"><span>2025-06-04T01:56:49.612-04:00  INFO 16165 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span></span>
<span class="line"><span>2025-06-04T01:56:49.612-04:00  INFO 16165 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 262 ms</span></span>
<span class="line"><span>Application has started successfully!</span></span>
<span class="line"><span>2025-06-04T01:56:49.718-04:00  INFO 16165 --- [           main] ceWritingOAuth2AccessTokenResponseClient : Request URI: http://localhost:8080/realms/master/protocol/openid-connect/token?audience=httpbin.org</span></span>
<span class="line"><span>Received a successful response from the REST client!</span></span>
<span class="line"><span>Application has completed successfully!</span></span>
<span class="line"><span>2025-06-04T01:56:50.068-04:00  INFO 16165 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8081 (http) with context path '/'</span></span>
<span class="line"><span>2025-06-04T01:56:50.072-04:00  INFO 16165 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 0.866 seconds (process running for 1.054)</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span></code></pre> </article> <ul class="my-8 astro-vj4tpspi"> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/software/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-2"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">software</span> </a> </li> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/spring-boot/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-3"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">spring-boot</span> </a> </li> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/java/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-4"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">java</span> </a> </li> <li class="inline-block my-1 underline-offset-4 astro-blwjyjpt"> <a href="/tags/oauth/" class="text-sm pr-2 group astro-blwjyjpt" data-astro-transition-scope="astro-36ssibgs-5"> <svg xmlns="http://www.w3.org/2000/svg" class=" scale-75 astro-blwjyjpt"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">oauth</span> </a> </li>  </ul> <div class="flex flex-col-reverse items-center justify-between gap-6 sm:flex-row-reverse sm:items-end sm:gap-4 astro-vj4tpspi"> <button id="back-to-top" class="focus-outline whitespace-nowrap py-1 hover:opacity-75 astro-vj4tpspi"> <svg xmlns="http://www.w3.org/2000/svg" class="rotate-90 astro-vj4tpspi"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg> <span class="astro-vj4tpspi">Back to Top</span> </button> <div class="social-icons astro-wkojbtzc"> <span class="italic astro-wkojbtzc">Share this post on:</span> <div class="text-center astro-wkojbtzc"> <a href="https://wa.me/?text=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via WhatsApp"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"></path>
      <path d="M9 10a0.5 .5 0 0 0 1 0v-1a0.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a0.5 .5 0 0 0 0 -1h-1a0.5 .5 0 0 0 0 1"></path>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via WhatsApp</span> </a><a href="https://www.facebook.com/sharer.php?u=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post on Facebook"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3"
    ></path>
  </svg> <span class="sr-only astro-wkojbtzc">Share this post on Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Tweet this post"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z"></path>
    </svg> <span class="sr-only astro-wkojbtzc">Tweet this post</span> </a><a href="https://t.me/share/url?url=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via Telegram"> <svg
        xmlns="http://www.w3.org/2000/svg"
        class="icon-tabler"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4"></path>
      </svg> <span class="sr-only astro-wkojbtzc">Share this post via Telegram</span> </a><a href="https://pinterest.com/pin/create/button/?url=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post on Pinterest"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <line x1="8" y1="20" x2="12" y2="11"></line>
      <path d="M10.7 14c.437 1.263 1.43 2 2.55 2c2.071 0 3.75 -1.554 3.75 -4a5 5 0 1 0 -9.7 1.7"></path>
      <circle cx="12" cy="12" r="9"></circle>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post on Pinterest</span> </a><a href="mailto:?subject=See%20this%20post&#38;body=https://stevenpg.com/posts/spring-oauth2-client-dynamic-audience/" class="group inline-block hover:text-skin-accent link-button astro-wkojbtzc" title="Share this post via email"> <svg
      xmlns="http://www.w3.org/2000/svg"
      class="icon-tabler"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg> <span class="sr-only astro-wkojbtzc">Share this post via email</span> </a> </div> </div>  </div> <hr class="my-6 border-dashed astro-vj4tpspi"> <!-- Previous/Next Post Buttons --> <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 astro-vj4tpspi"> <a href="/posts/spring-data-page-impl-serialization-warning" class="flex w-full gap-1 hover:opacity-75 astro-vj4tpspi"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-left flex-none astro-vj4tpspi">  <path stroke="none" d="M0 0h24v24H0z" fill="none" class="astro-vj4tpspi"></path> <path d="M15 6l-6 6l6 6" class="astro-vj4tpspi"></path>  </svg> <div class="astro-vj4tpspi"> <span class="astro-vj4tpspi">Previous Post</span> <div class="text-sm text-skin-accent/85 astro-vj4tpspi">Spring Data Pagination Serialization Warning</div> </div> </a> <a href="/posts/casual-machine-perf-test" class="flex w-full justify-end gap-1 text-right hover:opacity-75 sm:col-start-2 astro-vj4tpspi"> <div class="astro-vj4tpspi"> <span class="astro-vj4tpspi">Next Post</span> <div class="text-sm text-skin-accent/85 astro-vj4tpspi">Casual Machine Performance Test</div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-right flex-none astro-vj4tpspi">  <path stroke="none" d="M0 0h24v24H0z" fill="none" class="astro-vj4tpspi"></path> <path d="M9 6l6 6l-6 6" class="astro-vj4tpspi"></path>  </svg> </a> </div> </main> <footer class="mt-auto astro-sz7xmlte"> <div class="buy-me-coffee-container astro-3wdxegd7" data-astro-transition-persist="buy-me-coffee"> <a href="https://www.buymeacoffee.com/codingsteve" target="_blank" rel="noopener noreferrer" class="buy-me-coffee-button astro-3wdxegd7"> <span class="emoji astro-3wdxegd7">💡</span> <span class="text astro-3wdxegd7">Help Keep This Site Running</span> </a> </div>  <div class="max-w-3xl mx-auto px-0"> <hr class="border-skin-line" aria-hidden="true"> </div> <div class="footer-wrapper astro-sz7xmlte"> <div class="social-icons flex astro-upu6fzxr"> <a href="https://github.com/stevenpg" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title=" Coding Steve on Github"> <svg
    xmlns="http://www.w3.org/2000/svg"
    class="icon-tabler"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path
      d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"
    ></path>
  </svg> <span class="sr-only astro-upu6fzxr"> Coding Steve on Github</span> </a><a href="https://stevenpg1.substack.com/" class="group inline-block hover:text-skin-accent link-button astro-upu6fzxr" title=" Coding Steve on Substack"> <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" fill="currentColor" class="bi bi-substack" viewBox="0 0 16 16">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M15 3.604H1v1.891h14v-1.89ZM1 7.208V16l7-3.926L15 16V7.208zM15 0H1v1.89h14z"/>
    </svg> <span class="sr-only astro-upu6fzxr"> Coding Steve on Substack</span> </a> </div>  <div class="copyright-wrapper astro-sz7xmlte"> <span class="astro-sz7xmlte">Copyright &#169; 2025</span> <span class="separator astro-sz7xmlte">&nbsp;|&nbsp;</span> <span class="astro-sz7xmlte">All rights reserved.</span> </div> </div> </footer>   </body></html>  <script data-astro-rerun>
  /** Create a progress indicator
   *  at the top */
  function createProgressBar() {
    // Create the main container div
    const progressContainer = document.createElement("div");
    progressContainer.className =
      "progress-container fixed top-0 z-10 h-1 w-full bg-skin-fill";

    // Create the progress bar div
    const progressBar = document.createElement("div");
    progressBar.className = "progress-bar h-1 w-0 bg-skin-accent";
    progressBar.id = "myBar";

    // Append the progress bar to the progress container
    progressContainer.appendChild(progressBar);

    // Append the progress container to the document body or any other desired parent element
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  /** Update the progress bar
   *  when user scrolls */
  function updateScrollProgress() {
    document.addEventListener("scroll", () => {
      const winScroll =
        document.body.scrollTop || document.documentElement.scrollTop;
      const height =
        document.documentElement.scrollHeight -
        document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      if (document) {
        const myBar = document.getElementById("myBar");
        if (myBar) {
          myBar.style.width = scrolled + "%";
        }
      }
    });
  }
  updateScrollProgress();

  /** Attaches links to headings in the document,
   *  allowing sharing of sections easily */
  function addHeadingLinks() {
    const headings = Array.from(
      document.querySelectorAll("h2, h3, h4, h5, h6")
    );
    for (const heading of headings) {
      heading.classList.add("group");
      const link = document.createElement("a");
      link.className =
        "heading-link ml-2 opacity-0 group-hover:opacity-100 focus:opacity-100";
      link.href = "#" + heading.id;

      const span = document.createElement("span");
      span.ariaHidden = "true";
      span.innerText = "#";
      link.appendChild(span);
      heading.appendChild(link);
    }
  }
  addHeadingLinks();

  /** Attaches copy buttons to code blocks in the document,
   * allowing users to copy code easily. */
  function attachCopyButtons() {
    const copyButtonLabel = "Copy";
    const codeBlocks = Array.from(document.querySelectorAll("pre"));

    for (const codeBlock of codeBlocks) {
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";

      const copyButton = document.createElement("button");
      copyButton.className =
        "copy-code absolute right-3 -top-3 rounded bg-skin-card px-2 py-1 text-xs leading-4 text-skin-base font-medium";
      copyButton.innerHTML = copyButtonLabel;
      codeBlock.setAttribute("tabindex", "0");
      codeBlock.appendChild(copyButton);

      // wrap codebock with relative parent element
      codeBlock?.parentNode?.insertBefore(wrapper, codeBlock);
      wrapper.appendChild(codeBlock);

      copyButton.addEventListener("click", async () => {
        await copyCode(codeBlock, copyButton);
      });
    }

    async function copyCode(block, button) {
      const code = block.querySelector("code");
      const text = code?.innerText;

      await navigator.clipboard.writeText(text ?? "");

      // visual feedback that task is completed
      button.innerText = "Copied";

      setTimeout(() => {
        button.innerText = copyButtonLabel;
      }, 700);
    }
  }
  attachCopyButtons();

  /** Scrolls the document to the top when
   * the "Back to Top" button is clicked. */
  function backToTop() {
    document.querySelector("#back-to-top")?.addEventListener("click", () => {
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
    });
  }
  backToTop();

  /* Go to page start after page swap */
  document.addEventListener("astro:after-swap", () =>
    window.scrollTo({ left: 0, top: 0, behavior: "instant" })
  );
</script>